import "pe"

rule Stealc_Infostealer_Dropper {
    meta:
        description = "Detects Stealc infostealer dropper with embedded cabinet payload"
        author = "Peris.ai Threat Research Team"
        date = "2026-02-16"
        threat = "Stealc"
        malware_family = "Stealc"
        severity = "high"
        reference = "https://bazaar.abuse.ch"
        
    strings:
        $cab = { 4D 53 43 46 }  // Cabinet signature
        $pdb = "wextract.pdb" ascii
        $msgstr = "Msgstr.cab" ascii
        $newbie = "Newbie.cab" ascii
        $setupapi = "setupapi.dll" ascii
        $advpack = "advpack.dll" ascii
        
    condition:
        uint16(0) == 0x5A4D and
        filesize > 30MB and
        pe.number_of_sections == 6 and
        $cab and $pdb and ($msgstr or $newbie) and
        ($setupapi or $advpack)
}

rule Stealc_Embedded_Payload {
    meta:
        description = "Detects Stealc embedded x64 shellcode payload"
        author = "Peris.ai Threat Research Team"
        date = "2026-02-16"
        threat = "Stealc"
        
    strings:
        $code1 = { 48 8B ?? 48 8D ?? 24 ?? E8 }
        $code2 = { 48 8D ?? 24 ?? 48 8B ?? E8 }
        $api_fibers = "api-ms-win-core-fibers" ascii
        $api_xstate = "api-ms-win-core-xstate" ascii
        $mscoree = "mscoree.dll" ascii
        
    condition:
        2 of ($code*) and
        ($api_fibers or $api_xstate or $mscoree)
}
